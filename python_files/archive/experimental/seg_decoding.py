import shutil
import torch
import torchvision.transforms as tf
import nibabel as nib
import numpy as np
import pandas as pd
import os
from glob import glob
import matplotlib.pyplot as plt
import os
from PIL import Image

import pydicom
from tqdm import tqdm
# from masked_reconstruction import AFFINE_DCM
from extra.alignment import get_lung_region_single
from utils import crop_out_edges

AFFINE_DCM = np.array([
    [-0.139, 0, 0, 0],
    [0, -0.139, 0, 0],
    [0, 0, 1, 0],
    [0, 0, 0, 1]
], dtype=np.float64)


# left = '429777 50 431511 55 433244 62 434977 68 436711 73 438444 80 440177 86 441911 91 443644 98 445378 103 447111 109 448844 116 450578 121 452311 127 454044 134 455778 139 457512 144 459247 147 460982 150 462717 153 464452 156 466187 159 467922 162 469657 165 471392 168 473127 171 474862 174 476597 177 478332 181 480067 184 481802 187 483537 190 485272 193 487007 196 488742 199 490477 202 492212 205 493947 208 495682 211 497417 214 499152 217 500887 220 502622 223 504357 226 506092 228 507827 231 509562 233 511297 236 513032 239 514767 241 516502 244 518237 247 519972 249 521707 252 523442 255 525178 256 526913 259 528649 260 530384 263 532119 266 533855 267 535590 270 537326 272 539061 274 540796 277 542532 279 544267 281 546003 283 547738 285 549473 288 551209 290 552944 292 554680 293 556415 295 558150 297 559886 298 561621 300 563357 301 565092 303 566827 305 568563 306 570298 308 572034 309 573769 311 575504 313 577240 314 578975 316 580711 317 582446 319 584181 321 585917 322 587652 324 589388 325 591123 327 592859 328 594595 329 596331 330 598067 331 599802 333 601538 334 603274 335 605010 336 606746 337 608482 338 610218 339 611954 340 613689 342 615425 343 617161 344 618897 345 620633 346 622369 347 624105 348 625841 349 627576 351 629312 352 631048 353 632784 354 634520 354 636256 355 637992 356 639728 357 641463 359 643199 360 644935 361 646671 362 648407 363 650143 364 651880 364 653616 364 655353 364 657089 365 658825 366 660562 366 662298 367 664035 367 665771 368 667508 368 669244 369 670980 370 672717 369 674453 370 676190 370 677926 371 679662 372 681399 372 683135 373 684872 373 686608 374 688345 374 690081 375 691820 372 693561 368 695302 364 697043 360 698785 355 700526 351 702267 347 704008 342 705748 339 707486 338 709224 337 710963 334 712701 333 714439 332 716177 331 717916 328 719654 327 721392 326 723131 323 724869 322 726607 321 728346 319 730084 317 731822 316 733560 315 735299 313 737037 311 738775 310 740513 309 742249 309 743986 309 745723 309 747459 310 749196 309 750933 309 752669 310 754406 309 756143 309 757879 310 759616 310 761353 309 763089 310 764826 310 766563 310 768299 310 770036 310 771773 310 773509 310 775246 310 776983 310 778720 310 780456 310 782193 310 783930 310 785666 311 787403 310 789140 310 790876 311 792613 310 794350 310 796086 311 797823 311 799560 310 801296 311 803033 311 804770 310 806506 311 808243 311 809980 311 811716 311 813453 311 815189 312 816926 312 818662 312 820399 312 822135 313 823871 313 825608 313 827344 314 829080 315 830817 314 832553 315 834290 315 836026 315 837762 316 839499 316 841235 317 842972 316 844708 317 846444 318 848181 317 849917 318 851653 319 853390 319 855126 319 856863 319 858599 320 860335 321 862072 320 863808 321 865544 322 867281 321 869017 322 870754 322 872490 323 874226 323 875963 323 877699 324 879436 323 881172 324 882908 324 884645 324 886381 324 888117 325 889854 325 891590 325 893327 325 895063 325 896799 326 898535 327 900272 326 902008 327 903744 327 905480 328 907216 328 908953 328 910689 329 912425 329 914161 330 915897 330 917634 330 919370 330 921106 331 922842 332 924578 332 926315 332 928051 332 929787 333 931523 333 933259 334 934996 334 936732 334 938468 335 940204 335 941940 336 943677 336 945413 336 947149 337 948885 337 950621 338 952358 337 954094 338 955830 338 957566 339 959302 339 961039 339 962775 339 964511 340 966247 340 967983 340 969720 340 971456 340 973192 341 974928 341 976664 341 978401 341 980137 341 981873 342 983609 342 985345 343 987082 342 988818 342 990554 343 992290 343 994026 344 995762 344 997499 344 999235 344 1000971 344 1002707 345 1004443 345 1006179 346 1007916 345 1009652 346 1011388 346 1013124 346 1014860 347 1016597 346 1018333 347 1020069 347 1021805 347 1023541 348 1025277 348 1027014 348 1028750 348 1030486 349 1032222 349 1033958 349 1035695 349 1037431 349 1039167 350 1040903 350 1042639 351 1044375 351 1046112 351 1047848 351 1049584 352 1051320 352 1053056 353 1054792 353 1056529 353 1058265 353 1060001 354 1061737 354 1063473 355 1065209 355 1066945 356 1068682 355 1070418 356 1072154 356 1073890 357 1075626 357 1077362 357 1079098 358 1080834 358 1082571 358 1084307 358 1086043 359 1087779 359 1089515 360 1091251 360 1092987 361 1094723 361 1096460 361 1098196 361 1099932 362 1101668 362 1103404 363 1105140 363 1106876 364 1108612 364 1110349 364 1112085 364 1113821 365 1115557 365 1117293 366 1119029 366 1120765 366 1122501 367 1124238 366 1125974 366 1127710 366 1129446 367 1131182 367 1132918 367 1134654 368 1136390 368 1138127 367 1139863 368 1141599 368 1143335 368 1145071 368 1146808 368 1148544 368 1150280 368 1152016 369 1153753 368 1155489 368 1157225 369 1158962 368 1160698 368 1162434 368 1164171 368 1165907 368 1167643 368 1169379 369 1171116 368 1172852 368 1174588 369 1176325 368 1178061 368 1179797 368 1181533 369 1183270 368 1185006 368 1186742 369 1188479 368 1190215 368 1191951 369 1193687 369 1195424 368 1197160 368 1198896 369 1200633 368 1202369 368 1204105 368 1205842 368 1207578 368 1209314 368 1211050 368 1212787 367 1214523 368 1216260 367 1217996 367 1219733 366 1221469 366 1223206 366 1224943 365 1226679 365 1228416 364 1230153 364 1231889 364 1233626 363 1235362 363 1237099 362 1238836 362 1240572 362 1242309 361 1244045 361 1245782 360 1247519 360 1249255 360 1250992 359 1252729 358 1254465 358 1256202 358 1257938 358 1259675 357 1261412 356 1263148 356 1264885 356 1266622 355 1268358 355 1270095 354 1271831 355 1273568 354 1275305 353 1277041 353 1278778 352 1280515 352 1282251 352 1283988 351 1285724 351 1287461 350 1289198 349 1290934 349 1292671 348 1294408 348 1296144 348 1297881 347 1299617 347 1301354 346 1303091 345 1304827 345 1306564 344 1308301 343 1310037 343 1311774 342 1313510 343 1315247 342 1316984 341 1318720 341 1320457 340 1322194 339 1323930 339 1325667 338 1327403 338 1329140 337 1330877 336 1332613 336 1334350 336 1336087 335 1337823 335 1339560 334 1341297 333 1343033 333 1344770 332 1346507 331 1348243 331 1349980 330 1351717 329 1353454 329 1355190 329 1356927 328 1358664 327 1360400 327 1362137 326 1363874 325 1365610 325 1367347 324 1369084 323 1370820 323 1372557 322 1374294 321 1376030 321 1377767 320 1379504 319 1381240 319 1382977 317 1384714 316 1386451 315 1388187 315 1389924 314 1391661 313 1393397 313 1395134 312 1396871 311 1398607 311 1400344 310 1402081 309 1403817 309 1405554 308 1407291 307 1409027 307 1410764 306 1412501 305 1414237 305 1415974 304 1417711 303 1419447 303 1421184 301 1422921 300 1424657 300 1426394 299 1428131 298 1429867 298 1431604 297 1433341 296 1435077 296 1436814 295 1438550 295 1440287 294 1442024 293 1443760 293 1445497 292 1447234 291 1448970 291 1450707 290 1452444 289 1454180 289 1455917 288 1457654 287 1459390 287 1461127 287 1462864 286 1464600 286 1466337 285 1468074 284 1469810 284 1471547 283 1473284 282 1475020 282 1476757 281 1478493 281 1480230 280 1481967 279 1483703 279 1485440 278 1487176 278 1488913 277 1490650 276 1492386 276 1494123 275 1495859 275 1497596 274 1499333 274 1501069 274 1502806 273 1504542 273 1506279 272 1508016 271 1509752 271 1511489 270 1513225 270 1514962 269 1516699 268 1518435 268 1520172 267 1521908 267 1523645 266 1525382 265 1527118 265 1528855 264 1530591 264 1532328 263 1534065 262 1535801 262 1537538 262 1539274 262 1541011 261 1542747 261 1544483 261 1546220 260 1547956 260 1549692 260 1551428 260 1553164 260 1554901 259 1556637 259 1558373 259 1560109 259 1561845 259 1563582 258 1565318 258 1567054 258 1568790 258 1570526 258 1572263 257 1573999 257 1575735 258 1577471 258 1579207 258 1580944 257 1582680 257 1584416 257 1586152 257 1587888 257 1589624 257 1591361 256 1593097 256 1594833 256 1596569 256 1598305 256 1600042 255 1601778 255 1603514 255 1605250 254 1606986 254 1608723 253 1610459 253 1612195 253 1613931 253 1615667 253 1617404 252 1619140 252 1620876 252 1622612 252 1624348 252 1626085 250 1627821 250 1629557 250 1631293 250 1633029 250 1634765 250 1636501 250 1638237 250 1639973 250 1641710 249 1643446 249 1645182 249 1646918 248 1648654 248 1650390 248 1652126 248 1653862 248 1655598 248 1657334 248 1659070 248 1660806 248 1662542 248 1664279 247 1666015 247 1667751 246 1669487 246 1671223 246 1672959 246 1674695 246 1676431 246 1678167 246 1679903 246 1681639 246 1683375 246 1685112 245 1686848 245 1688584 244 1690320 244 1692056 244 1693792 244 1695528 244 1697264 244 1699000 244 1700736 244 1702472 244 1704208 244 1705944 244 1707681 243 1709417 242 1711153 242 1712889 242 1714625 242 1716361 242 1718097 242 1719833 242 1721569 242 1723304 243 1725040 243 1726776 243 1728512 243 1730248 242 1731984 242 1733719 243 1735455 243 1737191 243 1738927 243 1740663 243 1742399 243 1744134 244 1745870 244 1747606 244 1749342 244 1751078 243 1752814 243 1754549 244 1756285 244 1758021 244 1759757 244 1761493 244 1763229 244 1764964 245 1766700 245 1768436 244 1770172 244 1771908 244 1773644 244 1775379 245 1777115 245 1778851 245 1780587 245 1782323 244 1784059 244 1785795 244 1787531 244 1789268 243 1791004 243 1792740 243 1794476 243 1796212 242 1797948 242 1799684 242 1801420 242 1803156 242 1804893 241 1806629 241 1808365 241 1810101 240 1811837 240 1813573 240 1815309 240 1817045 240 1818782 239 1820518 239 1822254 239 1823990 238 1825726 238 1827462 238 1829198 238 1830934 238 1832670 238 1834407 237 1836143 237 1837879 236 1839615 236 1841351 236 1843089 234 1844829 230 1846569 226 1848308 223 1850048 219 1851788 214 1853528 210 1855267 207 1857007 203 1858747 199 1860487 195 1862229 189 1863970 183 1865712 177 1867453 172 1869195 166 1870936 161 1872678 155 1874417 152 1876155 150 1877892 148 1879629 147 1881367 145 1883104 144 1884841 143 1886579 141 1888316 140 1890053 138 1891791 136 1893528 135 1895265 134 1897003 132 1898740 131 1900477 130 1902215 127 1903952 126 1905689 125 1907427 123 1909165 121 1910903 119 1912642 116 1914381 112 1916119 110 1917858 107 1919596 105 1921335 102 1923073 100 1924812 97 1926551 94 1928289 91 1930028 88 1931766 86 1933504 84 1935242 82 1936980 80 1938718 78 1940456 75 1942194 73 1943932 71 1945670 69 1947407 68 1949145 65 1950883 63 1952621 61 1954359 59 1956097 56 1957835 54 1959572 53 1961310 50 1963048 48 1964786 46 1966524 43 1968262 41 1970000 39 1971738 37 1973475 35 1975212 34 1976949 33 1978686 31 1980423 30 1982160 29 1983898 27 1985635 25 1987372 24 1989109 23 1990846 21 1992583 20 1994320 19 1996057 18 1997794 16 1999531 15 2001268 14 2003005 12 2004742 11 2006480 9 2008217 7 2009954 6 2011691 5 2013428 4 2015165 2 2016902 1'
# right = '377323 4 379056 11 380790 18 382523 25 384256 33 385990 39 387723 47 389456 54 391190 61 392923 68 394656 76 396390 82 398123 88 399856 92 401590 95 403323 98 405057 101 406791 104 408526 106 410261 108 411995 111 413730 112 415465 114 417199 117 418934 119 420669 121 422403 124 424138 125 425873 127 427607 130 429342 132 431077 134 432811 137 434546 138 436280 141 438015 143 439750 145 441484 148 443219 150 444954 151 446688 154 448423 156 450158 158 451892 161 453627 163 455362 164 457096 167 458831 169 460566 171 462300 174 464035 176 465769 178 467504 180 469239 182 470973 185 472708 187 474443 189 476177 191 477912 193 479647 195 481381 197 483116 198 484851 199 486585 201 488320 202 490054 205 491789 206 493524 207 495258 209 496993 210 498728 211 500462 213 502197 214 503932 215 505666 217 507401 218 509135 221 510870 222 512605 223 514339 225 516074 226 517809 227 519543 229 521278 230 523013 231 524747 233 526482 235 528217 236 529951 238 531686 239 533421 240 535156 241 536890 243 538625 244 540360 245 542095 246 543830 247 545565 249 547299 251 549034 252 550769 253 552504 254 554239 255 555973 257 557708 258 559443 259 561178 260 562913 261 564648 263 566382 265 568117 266 569852 267 571587 268 573322 269 575057 270 576791 272 578526 273 580261 274 581996 276 583731 277 585465 279 587200 280 588935 281 590670 282 592405 283 594140 284 595874 286 597609 287 599344 288 601079 289 602814 290 604549 290 606284 291 608019 292 609755 292 611490 293 613225 294 614960 295 616695 296 618430 297 620165 298 621900 299 623635 300 625371 300 627106 301 628841 302 630576 303 632311 303 634046 304 635781 305 637516 306 639251 307 640987 307 642722 308 644457 309 646192 310 647927 311 649662 312 651397 313 653132 314 654867 315 656603 315 658338 316 660073 316 661808 317 663543 318 665278 319 667013 320 668748 321 670483 322 672219 322 673954 323 675689 324 677424 325 679159 326 680894 327 682630 327 684365 328 686100 329 687835 329 689571 329 691306 330 693041 331 694776 332 696512 332 698247 333 699982 334 701718 334 703453 335 705188 336 706923 337 708659 337 710394 338 712129 339 713864 340 715600 340 717335 341 719070 342 720806 342 722541 343 724276 344 726011 345 727747 345 729482 346 731217 347 732953 347 734688 348 736423 349 738158 350 739894 350 741629 351 743364 352 745099 353 746835 353 748570 354 750305 355 752041 355 753776 356 755511 357 757246 358 758982 358 760717 359 762452 360 764187 361 765923 361 767658 362 769393 363 771128 364 772864 364 774599 365 776334 366 778069 367 779805 367 781540 368 783275 369 785010 370 786745 371 788481 371 790216 372 791951 373 793686 374 795422 374 797157 375 798892 376 800627 377 802363 377 804098 378 805833 379 807568 380 809303 381 811039 381 812774 382 814509 383 816244 384 817980 384 819715 385 821450 386 823185 387 824920 388 826656 388 828391 389 830126 390 831861 391 833597 391 835332 392 837067 393 838802 394 840538 394 842273 395 844008 396 845743 397 847479 397 849214 398 850950 398 852685 399 854421 399 856156 400 857892 400 859627 401 861363 401 863098 402 864834 402 866569 403 868305 403 870040 404 871776 404 873511 405 875246 406 876982 406 878717 407 880453 407 882188 408 883924 408 885659 409 887395 409 889130 410 890866 410 892601 411 894337 411 896072 412 897808 412 899543 413 901279 413 903014 414 904749 415 906485 415 908220 416 909956 416 911691 417 913427 417 915162 418 916898 418 918633 419 920369 419 922104 420 923840 420 925575 421 927311 421 929046 422 930782 422 932517 423 934253 423 935988 424 937724 424 939460 424 941195 425 942931 424 944667 424 946402 425 948138 425 949873 426 951609 426 953345 426 955080 427 956816 426 958552 426 960287 427 962023 427 963759 427 965494 428 967230 428 968966 428 970701 428 972437 428 974173 428 975908 429 977644 429 979380 429 981115 430 982851 429 984586 430 986322 430 988058 430 989793 431 991529 431 993265 431 995000 432 996736 431 998472 431 1000207 432 1001943 432 1003679 432 1005414 433 1007150 433 1008886 432 1010621 433 1012357 433 1014093 433 1015828 434 1017564 434 1019299 435 1021035 435 1022771 434 1024506 435 1026242 435 1027978 435 1029713 436 1031449 436 1033185 436 1034921 436 1036656 436 1038392 436 1040128 436 1041864 436 1043599 437 1045335 437 1047071 437 1048807 437 1050542 438 1052278 438 1054014 437 1055750 437 1057486 437 1059221 438 1060957 438 1062693 438 1064429 438 1066164 439 1067900 439 1069636 439 1071372 439 1073107 440 1074843 439 1076579 439 1078315 439 1080051 439 1081786 440 1083522 440 1085258 440 1086994 440 1088729 441 1090465 441 1092201 441 1093937 441 1095672 441 1097408 441 1099144 441 1100880 441 1102616 441 1104351 442 1106087 442 1107823 442 1109559 442 1111294 443 1113030 443 1114766 443 1116502 442 1118237 443 1119973 443 1121709 443 1123445 443 1125181 443 1126916 444 1128652 444 1130388 444 1132124 444 1133860 444 1135596 444 1137331 444 1139067 444 1140803 444 1142539 444 1144275 444 1146011 444 1147746 445 1149482 445 1151218 445 1152954 445 1154690 445 1156425 446 1158161 445 1159897 445 1161633 445 1163369 445 1165105 445 1166840 446 1168576 446 1170312 446 1172048 446 1173784 446 1175520 446 1177255 447 1178991 447 1180727 446 1182463 446 1184199 446 1185935 446 1187670 447 1189406 447 1191142 447 1192878 447 1194614 447 1196349 448 1198085 448 1199821 448 1201557 447 1203293 447 1205029 447 1206764 448 1208500 448 1210236 448 1211972 448 1213708 448 1215444 448 1217179 449 1218915 449 1220651 449 1222387 448 1224123 448 1225859 448 1227594 449 1229330 449 1231066 449 1232802 449 1234538 449 1236274 449 1238010 449 1239745 450 1241481 450 1243217 449 1244953 449 1246689 449 1248425 449 1250161 449 1251896 450 1253632 450 1255368 450 1257104 450 1258840 450 1260576 450 1262312 450 1264047 450 1265783 450 1267519 450 1269255 450 1270991 450 1272727 450 1274462 451 1276198 451 1277934 451 1279670 451 1281406 451 1283142 451 1284878 450 1286613 451 1288349 451 1290085 451 1291821 451 1293557 451 1295293 451 1297029 451 1298764 452 1300500 452 1302236 452 1303972 452 1305708 452 1307444 452 1309180 452 1310915 453 1312651 453 1314387 453 1316123 453 1317859 453 1319595 453 1321331 452 1323067 452 1324803 452 1326539 452 1328275 452 1330011 452 1331747 452 1333483 452 1335219 452 1336955 452 1338691 452 1340426 453 1342162 453 1343898 453 1345634 453 1347370 453 1349106 453 1350842 453 1352578 453 1354314 453 1356050 453 1357786 453 1359522 453 1361258 453 1362994 453 1364730 453 1366466 453 1368202 453 1369938 453 1371674 452 1373410 452 1375146 452 1376882 452 1378618 452 1380354 452 1382090 452 1383826 452 1385562 452 1387298 452 1389033 453 1390769 453 1392505 453 1394241 453 1395977 453 1397713 453 1399449 453 1401185 452 1402921 452 1404657 452 1406393 452 1408129 452 1409865 451 1411601 451 1413337 451 1415073 451 1416809 451 1418545 450 1420281 450 1422016 451 1423752 451 1425488 450 1427224 450 1428960 450 1430696 450 1432432 450 1434168 449 1435903 450 1437639 450 1439375 450 1441111 450 1442847 449 1444583 449 1446319 449 1448055 449 1449790 450 1451526 449 1453262 449 1454998 449 1456734 449 1458470 449 1460206 448 1461942 448 1463677 449 1465413 449 1467149 448 1468885 448 1470621 448 1472357 448 1474093 448 1475829 447 1477564 448 1479300 448 1481036 448 1482772 448 1484508 447 1486244 447 1487980 447 1489716 447 1491451 447 1493187 447 1494923 447 1496659 446 1498395 446 1500131 446 1501867 445 1503603 445 1505339 444 1507075 444 1508811 444 1510547 443 1512283 443 1514019 443 1515755 442 1517491 442 1519227 442 1520963 441 1522698 442 1524434 442 1526170 441 1527906 441 1529642 441 1531378 440 1533114 440 1534850 439 1536586 439 1538322 439 1540058 438 1541794 438 1543530 438 1545266 437 1547002 437 1548738 437 1550474 436 1552210 436 1553946 436 1555682 435 1557418 435 1559154 435 1560890 434 1562626 434 1564362 433 1566098 433 1567833 434 1569569 433 1571305 433 1573041 433 1574777 432 1576513 432 1578249 432 1579985 432 1581721 431 1583457 431 1585193 431 1586929 431 1588665 431 1590401 430 1592137 430 1593873 430 1595609 430 1597345 430 1599081 429 1600816 430 1602552 430 1604288 430 1606024 430 1607760 429 1609496 429 1611232 429 1612968 429 1614704 429 1616440 428 1618176 428 1619912 428 1621647 429 1623383 429 1625119 428 1626855 428 1628591 428 1630327 428 1632063 428 1633799 427 1635535 427 1637271 427 1639007 427 1640743 427 1642478 427 1644214 427 1645950 427 1647686 427 1649422 427 1651158 426 1652894 426 1654630 426 1656366 426 1658102 426 1659838 425 1661574 425 1663309 426 1665045 426 1666781 426 1668517 425 1670253 425 1671989 425 1673725 425 1675461 425 1677197 424 1678933 424 1680668 425 1682404 425 1684140 425 1685876 426 1687612 426 1689348 426 1691084 426 1692820 426 1694555 428 1696291 428 1698027 428 1699763 428 1701499 428 1703235 429 1704971 429 1706706 430 1708442 430 1710178 430 1711914 431 1713650 431 1715386 431 1717122 431 1718858 431 1720593 433 1722329 433 1724065 433 1725801 433 1727537 433 1729273 434 1731009 434 1732744 435 1734480 435 1736216 435 1737952 435 1739688 436 1741424 436 1743160 436 1744896 436 1746631 437 1748367 438 1750103 438 1751839 438 1753575 438 1755311 438 1757047 439 1758783 439 1760518 440 1762254 440 1763990 440 1765726 441 1767462 441 1769198 441 1770934 441 1772670 441 1774406 442 1776141 443 1777877 443 1779613 443 1781349 443 1783085 444 1784821 444 1786557 444 1788293 444 1790029 444 1791764 445 1793500 445 1795236 445 1796972 445 1798708 446 1800444 446 1802180 446 1803916 446 1805652 446 1807388 446 1809123 447 1810859 447 1812595 447 1814331 447 1816067 447 1817803 447 1819539 448 1821275 448 1823011 448 1824746 449 1826482 449 1828218 449 1829954 449 1831690 449 1833426 449 1835162 449 1836898 449 1838634 449 1840369 451 1842105 229 1842392 164 1843841 226 1844134 158 1845577 223 1845876 152 1847313 220 1847618 146 1849049 217 1849360 140 1850785 214 1851102 134 1852521 211 1852844 128 1854257 208 1854586 122 1855993 205 1856333 111 1857728 203 1858085 95 1859464 200 1859837 79 1861200 197 1861589 64 1862936 194 1863337 52 1864672 191 1865083 42 1866408 188 1866828 33 1868144 185 1868573 24 1869880 182 1870319 14 1871616 179 1872064 5 1873352 176 1875088 173 1876823 171 1878559 168 1880295 166 1882031 164 1883767 162 1885503 161 1887239 159 1888975 157 1890711 156 1892447 154 1894182 154 1895918 152 1897654 150 1899390 149 1901126 147 1902862 145 1904598 144 1906334 142 1908070 140 1909806 139 1911542 137 1913277 137 1915013 135 1916749 133 1918485 132 1920221 130 1921957 128 1923693 127 1925429 125 1927165 123 1928901 122 1930637 120 1932372 120 1934108 118 1935844 116 1937580 115 1939316 113 1941052 111 1942788 110 1944524 109 1946260 108 1947996 107 1949732 106 1951468 105 1953204 103 1954940 102 1956676 101 1958412 100 1960148 99 1961884 98 1963620 97 1965356 96 1967092 95 1968828 94 1970564 93 1972300 92 1974036 91 1975772 89 1977508 88 1979244 87 1980980 86 1982716 85 1984452 84 1986188 83 1987924 82 1989660 81 1991396 80 1993132 79 1994868 78 1996604 77 1998340 75 2000076 74 2001812 73 2003548 72 2005284 71 2007020 70 2008756 69 2010492 68 2012228 67 2013964 66 2015700 65 2017436 64 2019172 63 2020908 61 2022644 60 2024380 59 2026116 58 2027852 57 2029589 55 2031325 54 2033061 53 2034798 51 2036534 50 2038270 49 2040007 47 2041743 46 2043479 46 2045216 44 2046952 43 2048688 42 2050425 40 2052161 39 2053897 38 2055634 36 2057370 35 2059106 34 2060843 32 2062579 31 2064315 30 2066052 28 2067788 28 2069524 27 2071261 25 2072997 24 2074733 23 2076470 21 2078206 20 2079942 19 2081679 17 2083415 16 2085151 15 2086888 13 2088624 12 2090360 11 2092097 10 2093833 9 2095569 8 2097306 6 2099042 5 2100778 4 2102515 2 2104251 1'
# hei = 2022
# wid = 1736
# dic_id = '1df86c6a-c5308f87-4dae24bf-5acfe642-c5e79dd4'


# def convert_dcm_to_nifti(dicom_dir):
#     reader = sitk.ImageSeriesReader()
#     dicom_series = reader.GetGDCMSeriesFileNames(dicom_dir)
#     print(dicom_series)
#     exit()
#     reader.SetFileNames(dicom_series)
#     image = reader.Execute()
#
#     nifti_image = sitk.GetArrayFromImage(image)
#     nifti_image = sitk.GetImageFromArray(nifti_image)
#
#     nifti_output_path = f'file.nii.gz'
#     sitk.WriteImage(nifti_image, nifti_output_path)


def decode_scan(f_path, dst_dir, height, width, left_lung, right_lung, heart=None, save=True, ret_data=False):
    data = np.zeros(height * width)

    objects = [left_lung, right_lung]
    if heart is not None:
        objects.append(heart)

    for r, obj in enumerate(objects):
        read = True
        cur_idx = 0
        for idx in obj:
            if read:
                cur_idx = idx
            else:
                data[cur_idx: cur_idx + idx] = r + 1
            read = not read

    data = data.reshape((height, width)).T
    if save:
        seg = nib.Nifti1Image(data, affine=AFFINE_DCM)
        no_suf = os.path.basename(f_path).split('.')[0]
        # dir_name = os.path.dirname(f_path)
        out_file = f'{os.path.join(dst_dir, no_suf)}_seg.nii.gz'
        print(f'saving {os.path.join(dst_dir, no_suf)}')
        nib.save(seg, out_file)
    if ret_data:
        return data.astype(np.int16)


if __name__ == '__main__':
    # resize = tf.Resize((512, 512))
    # p = '/cs/casmip/itamar_sab/LongitudinalCXRAnalysis/VinDrCXR/redownload2/9fcac0e95f66d088f699258ebec37c9e.dicom'
    # d = pydicom.dcmread(p).pixel_array.T.squeeze().astype(np.int32)
    # d = torch.tensor(d)
    # d = resize(d[None, ...])
    # import kornia
    #
    # d= d.contiguous().view(1, 1, -1)
    # max_vals = torch.amax(d, dim=2, keepdim=True)
    # min_vals = torch.amin(d, dim=2, keepdim=True)
    # d = (d - min_vals) / (max_vals - min_vals)
    # d = d.view(1, 1, 512, 512)
    # d = kornia.enhance.equalize_clahe(d, clip_limit=1.8, grid_size=(8,8))
    # d = d.numpy().squeeze()
    # print(d.dtype)
    # nif = nib.Nifti1Image(d, AFFINE_DCM)
    # nib.save(nif, '/cs/casmip/itamar_sab/LongitudinalCXRAnalysis/VinDrCXR/redownload2/9fcac0e95f66d088f699258ebec37c9e.nii.gz')
    #
    # exit()

    csv_name = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/segmentations/CheXpert.csv'
    dir_path = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/train/images'
    dst_path = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/train/images_new_new'
    dst_seg_dir = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/train/images_segs'
    # dir_path = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/PadChest/images'
    # dst_path = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/PadChest/images_new'
    id_column = 'Path'
    # id_column = 'ImageID'

    train_labels_csv_path = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/train/train.csv'
    valid_labels_csv_path = '/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/valid/valid.csv'
    train_df = pd.read_csv(train_labels_csv_path)
    valid_df = pd.read_csv(valid_labels_csv_path)
    df = pd.concat([train_df, valid_df])
    df = df[df['Frontal/Lateral'] == 'Frontal']
    df[id_column] = df.apply(lambda r: r[id_column].replace('CheXpert-v1.0/', ''), axis=1)
    df[id_column] = df.apply(lambda r: r[id_column].replace('valid', 'train'), axis=1)
    # exit()
    orig_names = set(df[id_column])

    # img_names = os.listdir(dir_path)
    # orig_names = img_names

    # orig_names = set([n.split('.')[0] + '.dicom' for n in img_names])
    # orig_names = set([n.split('.')[0] for n in img_names])
    # src = '/cs/labs/josko/public/itamar_sab/physionet.org/files_removed/p15/'
    # hard_drive_path_base = "/media/itamar_sab/My Book/physionet.org/non_AP_files/p15/" # TODO: Transfer files to here after decoding and cropping.
    # print(f"Working on {dcms_num} DICOMs")
    # ids_to_paths = {os.path.basename(path).split('.')[0]: path for path in paths}
    resize = tf.Resize((768, 768))

    # df2 = pd.read_csv(csv_name)
    # df2[id_column] = df2.apply(lambda r: r[id_column].replace('CheXpert-v1.0/', ''), axis=1)
    # df2[id_column] = df2.apply(lambda r: r[id_column].replace('valid', 'train'), axis=1)
    # df2_ids = set(df2[id_column])
    #
    # df = df[df.apply(lambda r: r[id_column] in df2_ids, axis=1)]
    df = df[df.apply(lambda r: r[id_column] not in {'train/patient05271/study5/view2_frontal.jpg', 'train/patient48043/study1/view2_frontal.jpg',
                                                    'train/patient09797/study4/view1_frontal.jpg', 'train/patient12362/study1/view1_frontal.jpg',
                                                    'train/patient25979/study8/view1_frontal.jpg', 'train/patient44163/study1/view1_frontal.jpg',
                                                    'train/patient40255/study2/view1_frontal.jpg'}, axis=1)]
    # print('train/patient00202/study1/view2_frontal.jpg' in df['Path'].values)
    # print(df['Path'])
    # print('Current folder size')
    # os.system('du -sh /cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/physionet.org/other_files')

    copied = 0
    j = 0
    # c = 0

    # for chunk in tqdm(pd.read_csv(csv_name, chunksize=10 ** 4)):
    #     # if c >= dcms_num:
    #     #     print('Breaking early')
    #     #     break
    #     print(f'Going over {j * (10**4)}-{(j + 1) * (10**4) - 1}')
    #     j += 1
    #     # ids = chunk[id_column]
    #     chunk[id_column] = chunk.apply(lambda r: r[id_column].replace('valid', 'train'), axis=1)
    #     # inter = set(ids).intersection(ids_to_paths)
    #     rows = chunk.loc[chunk[id_column].isin(orig_names)]
    #     # print(orig_names)
    #     # rows = chunk.loc[chunk['Frontal/Lateral'] == 'Frontal']
    #     rows_len = len(rows)
    #     print(f'Intersection size is: {rows_len} out of {len(chunk)} in chunk')
    #     continue
    #     # if ''
    #     if not rows_len:
    #         continue
    do_hearts = True
    bad_cases = set(['/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/' + n.replace('train/', 'train/images/').replace('.jpg', '.nii.gz') for n in
                     {'train/patient05271/study5/view2_frontal.jpg', 'train/patient48043/study1/view2_frontal.jpg',
                      'train/patient09797/study4/view1_frontal.jpg', 'train/patient12362/study1/view1_frontal.jpg',
                      'train/patient25979/study8/view1_frontal.jpg', 'train/patient44163/study1/view1_frontal.jpg',
                      'train/patient40255/study2/view1_frontal.jpg'}])

    for k, chunk in tqdm(enumerate(pd.read_csv(csv_name, chunksize=10 ** 4))):
        if k < 13:
            continue
        for i, row in tqdm(chunk.iterrows()):
            row[id_column] = row[id_column].replace('valid', 'train')
            # c += 1
            c_id = row[id_column]
            # c_path = dir_path + f'/{c_id.split(".")[0]+".nii.gz"}'
            # c_path = dir_path + f'/{c_id}.dicom'
            # c_path = dir_path + f'/{c_id}'
            c_path = f'/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/Chexpert/train/images/{"/".join(c_id.split("/")[1:])}'.replace('.jpg', '.nii.gz')
            if c_path in bad_cases:
                continue
            dst_im = c_path.replace('images', 'images_new_new')
            dest_seg = c_path.replace('images', 'images_segs_lungs')
            dest_seg = dest_seg.replace('.nii.gz', '_seg.nii.gz')
            dst_heart_seg = dest_seg.replace('images_segs_lungs', 'images_segs_heart')

            try:
                c_left_lung = np.array(row['Left Lung'].split(), dtype=int)
                c_right_lung = np.array(row['Right Lung'].split(), dtype=int)
                if do_hearts:
                    c_heart = np.array(row['Heart'].split(), dtype=int)
                else:
                    c_heart = None
                c_height = row['Height']
                c_width = row['Width']

                c_seg = decode_scan(c_path, dst_path, c_height, c_width, c_left_lung, c_right_lung, heart=c_heart, save=False, ret_data=True)

                x_min, y_min, x_max, y_max = get_lung_region_single(c_seg.astype(bool))
            except Exception as e:
                print(f'Found outlier: {c_path}')
                print(e)
                continue

            lungs_seg = np.logical_or(c_seg == 1, c_seg == 2)
            heart_seg = c_seg == 3

            # cropped_seg = c_seg[x_min: x_max, y_min: y_max]

            # c_data = nib.load(c_path).get_fdata().T.squeeze()

            # c_dic = pydicom.dcmread(c_path)
            # c_data = c_dic.pixel_array.T.squeeze()

            # if i == 0:
            #     continue

            # img = Image.open(c_path).convert('I')
            # c_data = np.array(img.getdata()).astype(np.int32).reshape((c_height, c_width)).T
            # orig_dtype = c_data.dtype

            #######################

            img = nib.load(c_path)
            c_data = img.get_fdata()

            # t_size = c_height * c_width
            t_size = c_data.shape[-2] * c_data.shape[-1]
            if t_size < 200:
                print(f'Unusual image size: {c_data.shape[-2]}, {c_data.shape[-1]} in:\n{c_path}')

            c_max = np.max(c_data)
            c_min = np.min(c_data)
            c_data = (c_data - c_min) / (c_max - c_min)
            c_data = c_data * 255
            c_data = c_data.astype(np.uint8)

            min_v = np.min(c_data)
            min_perc = np.sum(c_data == min_v) / t_size
            if min_perc > 0.75:
                print(f'Min percentage {min_perc} in:\n{c_path}')

            max_v = np.max(c_data)
            max_perc = np.sum(c_data == max_v) / t_size
            if max_perc > 0.75:
                print(f'Max percentage {max_perc} in:\n{c_path}')

            std = np.std(c_data)
            if std < 0.1:
                print(f'STD {std} in:\n{c_path}')

            if min_v == max_v:
                print(f'Same min and max in:\n{c_path}')

            ########################

            # continue
            cropped_data = c_data[x_min: x_max, y_min: y_max]
            # cropped_c_seg = c_seg[x_min: x_max, y_min: y_max]
            cropped_lungs_seg = lungs_seg[x_min: x_max, y_min: y_max]
            cropped_heart_seg = heart_seg[x_min: x_max, y_min: y_max]

            # cropped_data, x_min, y_min, x_max, y_max = crop_out_edges(cropped_data, get_coords=True)
            # cropped_c_seg = cropped_c_seg[x_min: x_max, y_min: y_max]

            cropped_data = torch.tensor(cropped_data)
            # cropped_c_seg = torch.tensor(cropped_c_seg, dtype=torch.int)
            cropped_lungs_seg = torch.tensor(cropped_lungs_seg, dtype=torch.int)
            cropped_heart_seg = torch.tensor(cropped_heart_seg, dtype=torch.int)

            # try:
            #     if c_dic.PhotometricInterpretation == 'MONOCHROME1':
            #         c_data = 255 - c_data
            #     elif c_dic.PhotometricInterpretation == 'MONOCHROME2':
            #         pass
            #     else:
            #         print(f'Found image with PhotometricInterpretation {c_dic.PhotometricInterpretation}')
            # except Exception as e:
            #     print(f'Got this error:\n{e}')

            # c_data = torch.tensor(c_data)
            # cropped_data = resize(c_data[None, ...]).numpy().squeeze()
            cropped_data = resize(cropped_data[None, ...]).numpy().squeeze()
            # cropped_c_seg = resize(cropped_c_seg[None, ...]).numpy().squeeze()
            cropped_lungs_seg = resize(cropped_lungs_seg[None, ...]).numpy().squeeze()
            cropped_heart_seg = resize(cropped_heart_seg[None, ...]).numpy().squeeze()

            # c_max = np.max(cropped_data)
            # c_min = np.min(cropped_data)
            # c_max_f = np.max(cropped_data.astype(np.float16))
            # c_min_f = np.min(cropped_data.astype(np.float16))
            #
            # if c_max_f == np.inf or c_max_f == c_min_f or c_max != c_max_f or c_min != c_min_f:
            #     print(f'Something fucked with {c_path}')
            #     print(c_max)
            #     print(c_max_f)
            #     print(c_min)
            #     print(c_min_f)
            #     exit()

            # no_suf = os.path.basename(c_path).split('.')[0]
            # dir_name = os.path.dirname(c_path)

            # seg_out_file = f'{os.path.join(dir_name, no_suf)}_seg.nii.gz'
            # nib.save(c_seg, seg_out_file)
            #
            # cropped_seg_out_file = f'{os.path.join(dir_name, no_suf)}_cropped_seg.nii.gz'
            # nib.save(cropped_seg, cropped_seg_out_file)

            # new_dir_name = os.path.join(hard_drive_path_base, "/".join(dir_name.split('/')[-3:]))
            # os.makedirs(new_dir_name, exist_ok=True)
            # os.remove(c_path)
            # cropped_nib_nif = nib.Nifti1Image(cropped_data, AFFINE_DCM)
            # nib.save(cropped_nib_nif, c_path)

            cropped_nif = nib.Nifti1Image(cropped_data, AFFINE_DCM)
            # nib.save(cropped_nif, f'{dst_path}/{c_id.split(".")[0]}.nii.gz')
            os.makedirs(os.path.dirname(dst_im), exist_ok=True)
            nib.save(cropped_nif, dst_im)

            # cropped_lungs_seg = torch.tensor(cropped_c_seg)
            # cropped_lungs_seg = torch.isin(cropped_lungs_seg, torch.tensor([1, 2]))
            # cropped_lungs_seg = cropped_lungs_seg.numpy().astype(bool).astype(np.int16)

            cropped_lungs_seg_nif = nib.Nifti1Image(cropped_lungs_seg, AFFINE_DCM)
            # # nib.save(cropped_seg_nif, f'{dst_seg_dir}/{c_id.split(".")[0]}_seg.nii.gz')
            os.makedirs(os.path.dirname(dest_seg), exist_ok=True)
            nib.save(cropped_lungs_seg_nif, dest_seg)

            if do_hearts:
                cropped_heart_seg_nif = nib.Nifti1Image(cropped_heart_seg, AFFINE_DCM)
                # # nib.save(cropped_seg_nif, f'{dst_seg_dir}/{c_id.split(".")[0]}_seg.nii.gz')
                os.makedirs(os.path.dirname(dst_heart_seg), exist_ok=True)
                nib.save(cropped_heart_seg_nif, dst_heart_seg)

            # copied += 1
            # if copied > 2:
            #     exit()

    print(f'Copied in total {copied} files')

    # with open('/cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/physionet.org/outliers_supine.txt', 'w') as f:
    #     for o in outliers:
    #         f.write(f'{o}\n')

    # print('Current folder size')
    # os.system('du -sh /cs/labs/josko/itamar_sab/LongitudinalCXRAnalysis/physionet.org/other_files')
    #
    # shutil.move(c_path , os.path.join(hard_drive_path_base, correct_file_ending))
    # shutil.move(seg_out_file , os.path.join(hard_drive_path_base, correct_file_ending))
    # TODO: remove here to new path once this works properly

    # CROP AND SAVE
    # REMOVE ORIG TO NEW PATH
    # print(f'Found {c}/{dcms_num} so far')
    # for row in rows:
    # for path in paths:
    #     dicom_id = os.path.basename(path).split('.')[0]
    #     rows = df.loc[df['dicom_id'] == dicom_id]
    #     print(rows)
    #     exit()

    # left = left.split()
    # left = np.array(left, dtype=int)
    # right = right.split()
    # right = np.array(right, dtype=int)
    # print("starting")
    #
    # decode_scan(dic_id, hei, wid, left, right)
